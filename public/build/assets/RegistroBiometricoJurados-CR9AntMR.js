import{x as oe,T as se,r as m,w as A,c as k,o as D,b as f,u as l,Z as re,d as B,e as t,B as ie,p as le,l as ne,f as z,C as H,j as E,F as W,k as ce,t as J,v as de,z as ue}from"./app-CwXhlR0m.js";import{_ as me}from"./AuthenticatedLayout-C-RXFJjK.js";import{_ as Z}from"./TextInput-0rYGe8oa.js";import{_ as M}from"./InputError-CEmtE8gg.js";import{_ as fe}from"./PrimaryButton-fLY66Xoz.js";import{_ as G}from"./Modal-wDav3Hku.js";import{f as ve}from"./cedulaFrontEjemplo-eqgE4YJW.js";import{d as ge,T as pe,n as L}from"./FaceMatcher-DQZ88WER.js";import{r as be}from"./PhotoIcon-Be3MshPh.js";import{s as he}from"./index-Co7nR-9G.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BreadCrumb-Ck2sqtOV.js";import"./SecondaryButtonReturn-BVha_-nD.js";import"./XCircleIcon-DtfMs8L4.js";import"./index-COmakdS6.js";import"./index-vXgSwYTU.js";import"./index-BORUOjUc.js";const xe={class:"max-w-2xl mx-auto bg-white shadow-md rounded-lg p-8 mt-8"},we={class:"gap-6"},ye={class:"sm:grid sm:grid-cols-2 gap-2 h-full sm:px-16 px-4"},_e={class:"w-full h-full mt-4"},je={class:"w-full"},De=["src"],Ce={class:"mb-2 h-full flex justify-center items-center mt-4"},Fe={class:"border-2 border-gray-300 rounded-md p-2 h-full"},ke={class:"flex justify-center"},Be=["src","alt"],Ee={key:0,class:"flex justify-center mt-2"},Ie={class:"w-full"},Ve={class:"my-4 col-span-2 mb-2"},Te={class:"mb-4 col-span-2 mb-2"},Se={class:"flex justify-end mt-6"},Ue={class:"flex justify-center my-12"},Re={class:"my-12 px-4"},ze=["value"],Me=["disabled"],at={__name:"RegistroBiometricoJurados",setup(Le){const v=oe("$swal"),K=[{url:"",text:"Registro biometrico"}],o=se({cedula_front:null,campoObligatorio:"",embedding:null,photo:null,validaciones:"",checked:!0,declaracion:!0}),U=m(!1),p=m(!1),w=m(null),I=m([]),C=m(""),d=m(null),g=m(""),O=m(!1),y=m(!1),n=m(!1),j=m(0),Q=(s,e)=>o.cedula_front===null?`/storage/uploads/documentos/${s}`:s,X=(s,e)=>{const a=e.target.files[0];if(!a)return;((u,T)=>{const S=new FileReader;S.onload=R=>{const b=new Image;b.onload=()=>{const r=document.createElement("canvas"),_=r.getContext("2d"),h=1024,F=1024;let c=b.width,x=b.height;(c>h||x>F)&&(c>x?(x=Math.round(x*h/c),c=h):(c=Math.round(c*F/x),x=F)),r.width=c,r.height=x,_.drawImage(b,0,0,c,x),r.toBlob(q=>{if(q.size>2e6){Swal.fire({icon:"error",title:"Error",text:"Incluso comprimida, la imagen supera los 2MB."});return}const P=new File([q],u.name,{type:"image/jpeg",lastModified:Date.now()});T(P,URL.createObjectURL(P))},"image/jpeg",.8)},b.src=R.target.result},S.readAsDataURL(u)})(a,(u,T)=>{o[s]=u,w.value=T})},Y=s=>{o.cedula_front=null,w.value=null},ee=async()=>{n.value=!0;try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(i=>i.stop()),await L.tinyFaceDetector.loadFromUri("/models/tiny_face_detector"),await L.faceRecognitionNet.loadFromUri("/models/face_recognition"),await L.faceLandmark68Net.loadFromUri("/models/face_landmark_68");const e=await navigator.mediaDevices.enumerateDevices();I.value=e.filter(i=>i.kind==="videoinput");const a=I.value.find(i=>i.label.toLowerCase().includes("user"))||I.value[0];console.log(a),C.value=(a==null?void 0:a.deviceId)||"",n.value=!1,p.value=!0,await $(C.value)}catch(s){n.value=!1,j.value==3,console.error("Error al iniciar:",s),g.value="No se pudo acceder a la cámara."}},te=async()=>{n.value=!0,g.value="",y.value=!0;const s=a=>parseInt(sessionStorage.getItem(a)||"0"),e=(a,i)=>sessionStorage.setItem(a,i.toString());if(!O.value){s("fallo_camara")+1,g.value="La cámara no está lista.",y.value=!1,n.value=!1;return}try{const a=await ge(d.value,new pe).withFaceLandmarks().withFaceDescriptor();if(console.log("entro -- validador"),!a){n.value=!1,y.value=!1,g.value="No se detectó un rostro.",j.value+=1;const r=document.createElement("canvas");r.width=d.value.videoWidth,r.height=d.value.videoHeight,r.getContext("2d").drawImage(d.value,0,0,r.width,r.height);const h=await new Promise(c=>r.toBlob(c,"image/jpeg")),F=new File([h],"photo.jpg",{type:"image/jpeg"});o.photo=F,j.value==3&&v.fire({title:"Error en validación",text:"Error, no se detectó un rostro, vuelve a intentar o avanzar con la imagen poco visible y posiblemente sin registro biométrico (alta probabilidad de rechazo)",icon:"error",showCancelButton:!1,confirmButtonText:"Volver a intentar"}).then(c=>{c&&(console.log("Usuario decide volver a intentar"),g.value="",j.value=0,n.value=!1)});return}const i=a.descriptor;o.embedding=i,console.log("emb",i);const u=document.createElement("canvas");u.width=d.value.videoWidth,u.height=d.value.videoHeight,u.getContext("2d").drawImage(d.value,0,0,u.width,u.height);const S=await new Promise(r=>u.toBlob(r,"image/jpeg")),R=new File([S],"photo.jpg",{type:"image/jpeg"});o.photo=R;const b=new FormData;b.append("embedding",i),ue.post(route("face-validate-jurado"),b,{headers:{"Content-Type":"multipart/form-data"}}).then(r=>{g.value=r.data.message,console.log(r),y.value=!1,n.value=!1,p.value=!1,r.data.match?v.fire({title:"Error en validación",text:"Usted ya tiene un registro biométrico. Si está seguro que no se ha registrado, puede volver a intentarlo o continuar (probabilidad de rechazo).",icon:"error",showCancelButton:!1,confirmButtonText:"Volver a intentar"}).then(_=>{_.isConfirmed?(o.validaciones="registro_duplicado",p.value=!1,V()):_.dismiss===v.DismissReason.cancel&&console.log("Usuario decide volver a intentar")}):v({title:"Validación exitosa",text:"Validación biométrica exitosa",icon:"success",didClose:()=>{p.value=!1,n.value=!1,V()}})}).catch(r=>{y.value=!1,n.value=!1,console.log(r);const _=s("fallo_registro")+1;e("fallo_registro",_),v.fire({title:"Error en validación",text:"Error en la validación, vuelve a intentar o avanzar sin registro biometrico (posibilidad de rechazo)",icon:"error",showCancelButton:!0,cancelButtonText:"Volver a intentar",confirmButtonText:"Continuar"}).then(h=>{h.isConfirmed?(o.embedding="",o.validaciones="fallo_registro_biometrico",p.value=!1,V()):h.dismiss===v.DismissReason.cancel&&console.log("Usuario decide volver a intentar")})})}catch(a){console.error(a),y.value=!1,n.value=!1,j.value==3&&v.fire({title:"Error en validación",text:"Error al procesar el rostro, vuelve a intentar o avanzar sin registro biometrico (posibilidad de rechazo)",icon:"error",showCancelButton:!0,cancelButtonText:"Volver a intentar",confirmButtonText:"Continuar"}).then(i=>{i.isConfirmed?(o.embedding="",o.validaciones="fallo_registro",p.value=!1,V()):i.dismiss===v.DismissReason.cancel&&(console.log("Usuario decide volver a intentar"),g.value="",j.value=0)}),g.value="Error al procesar el rostro."}},ae=()=>{U.value=!1,console.log("Validando datos del paso 3",w.value),(o.cedula_front||w)&&(console.log("Datos del paso 3 son válidos"),U.value=!0),U.value?ee():o.cedula_front||(o.errors.cedula_front="Este campo es requerido.")},V=()=>{o.post(route("registro-biometrico-jurado"),{onSuccess:()=>{v({title:"Registro actualizado",text:"Registro de jurado actualizado exitosamente.",icon:"success"}).then(s=>{window.location.href=route("dashboard")}),sessionStorage.removeItem("fallo_camara"),sessionStorage.removeItem("fallo_registro"),sessionStorage.removeItem("registro_duplicado"),o.reset(),N()},onError:s=>{v({title:"Error",text:"Ocurrió un error al registrar el usuario.",icon:"error"}).then(e=>{}),console.error(s)}})},$=async s=>{try{const e=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:s}}});d.value.srcObject=e,O.value=!0}catch(e){console.error("Error al iniciar cámara:",e),g.value="Error al iniciar la cámara."}};A(C,async s=>{s&&await $(s)});const N=()=>{var e;const s=(e=d.value)==null?void 0:e.srcObject;s&&s.getTracks().forEach(a=>a.stop()),d.value.srcObject=null};return A(p,s=>{s==!1&&N()}),(s,e)=>(D(),k(W,null,[f(l(re),{title:"Registro biométrico de jurados"}),f(me,{breadCrumbLinks:K},{header:B(()=>e[7]||(e[7]=[t("h1",{class:"text-xl font-bold"},"Registro biométrico de jurados",-1)])),default:B(()=>[t("div",xe,[t("form",{onSubmit:ie(ae,["prevent"])},[t("div",we,[t("div",ye,[e[9]||(e[9]=t("div",{class:"col-span-2 text-sm sm:text-base text-gray-800 pt-6"},[t("h3",{class:"text-lg font-semibold"}," Cargue documento de identificación parte frontal "),t("p",null," Para cargar el documento frontal, asegúrese de que la imagen sea clara y legible. El documento debe estar bien iluminado y sin reflejos. ")],-1)),t("div",_e,[t("div",je,[e[8]||(e[8]=t("h4",{class:"text-2xl underline"},"Ejemplo parte frontal",-1)),t("img",{src:l(ve),alt:"Documento Frontal ejemplo",class:"w-full h-full object-contain mt-2"},null,8,De)])]),t("div",Ce,[t("div",Fe,[f(Z,{id:"cedula_front",type:"file",class:"mt-1 !border-0",accept:"image/jpeg,image/jpg,image/png,image/gif,image/svg+xml,image/webp",onInput:e[0]||(e[0]=a=>X("cedula_front",a)),maxFileSize:2e6}),f(M,{class:"mt-2",message:l(o).errors.cedula_front},null,8,["message"]),t("div",ke,[w.value?(D(),k("img",{key:0,src:Q(w.value,1),alt:l(o).cedula_front,class:"w-4/6 h-full object-contain"},null,8,Be)):(D(),ne(l(be),{key:1,class:"w-2/6 text-gray-300 flex justify-center items-center"}))]),w.value?(D(),k("div",Ee,[t("button",{onClick:e[1]||(e[1]=a=>Y(1)),type:"button",class:"bg-red-500 text-white px-4 py-2 rounded"}," Eliminar Imagen ")])):le("",!0)])])]),t("div",Ie,[f(Z,{id:"campo_obligatorio",type:"text",class:"mt-3 !border-0 hidden",modelValue:l(o).campoObligatorio,"onUpdate:modelValue":e[2]||(e[2]=a=>l(o).campoObligatorio=a)},null,8,["modelValue"])]),t("div",Ve,[z(t("input",{type:"checkbox",id:"consentimiento1",name:"consentimiento1",required:"","onUpdate:modelValue":e[3]||(e[3]=a=>l(o).checked=a)},null,512),[[H,l(o).checked]]),e[10]||(e[10]=t("label",{for:"consentimiento1",class:"ps-4 pe-12 sm:text-base text-sm text-gray-500"},[E("Conozco y Acepto la Política de Privacidad de Datos "),t("a",{href:"https://www.pereira.gov.co/publicaciones/38/politicas-de-privacidad-y-condiciones-de-uso/",target:"_blank",class:"underline !text-azul cursor-pointer"},"Política")],-1)),f(M,{class:"mt-1",message:l(o).errors.checked},null,8,["message"])]),t("div",Te,[z(t("input",{type:"checkbox",id:"consentimiento2",name:"consentimiento2",required:"","onUpdate:modelValue":e[4]||(e[4]=a=>l(o).declaracion=a)},null,512),[[H,l(o).declaracion]]),e[11]||(e[11]=t("label",{for:"consentimiento2",class:"ps-4 pe-12 sm:text-base text-sm text-gray-500"},[E("Manifiesto que acepto, bajo juramento, la "),t("a",{href:"https://www.pereira.gov.co/loader.php?lServicio=Tools2&lTipo=descargas&lFuncion=visorpdf&file=https%3A%2F%2Fwww.pereira.gov.co%2Floader.php%3FlServicio%3DTools2%26lTipo%3Ddescargas%26lFuncion%3DexposeDocument%26idFile%3D211273%26tmp%3De1c59e50ed23a13cda9087f627ac4f4d%26urlDeleteFunction%3Dhttps%253A%252F%252Fwww.pereira.gov.co%252Floader.php%253FlServicio%253DTools2%2526lTipo%253Ddescargas%2526lFuncion%253DdeleteTemporalFile%2526tmp%253De1c59e50ed23a13cda9087f627ac4f4d&pdf=1&tmp=e1c59e50ed23a13cda9087f627ac4f4d&fileItem=211273",target:"_blank",class:"underline !text-azul cursor-pointer"},"Declaración"),E(" sobre la veracidad de la información registrada")],-1)),f(M,{class:"mt-1",message:l(o).errors.declaracion},null,8,["message"])])]),t("div",Se,[f(fe,{disabled:l(o).processing},{default:B(()=>e[12]||(e[12]=[E(" Registrar jurado ")])),_:1},8,["disabled"])])],32)])]),_:1}),f(G,{show:n.value,closeable:!1},{default:B(()=>[e[13]||(e[13]=t("h2",{class:"py-4 text-2xl font-semibold text-gray-800 flex tex-center justify-center bg-azul text-white"}," Cargando datos... ",-1)),t("div",Ue,[f(l(he),{"aria-label":"Loading"})])]),_:1},8,["show"]),f(G,{show:p.value,closeable:!0},{default:B(()=>[e[15]||(e[15]=t("h2",{class:"py-4 text-2xl font-semibold text-gray-800 flex flex-wrap tex-center justify-center bg-azul text-white"}," Validación Biométrica ",-1)),e[16]||(e[16]=t("div",{class:"mt-4 px-4"},[t("p",{class:"text-sm sm:text-base text-gray-800"}," Por favor, asegúrese de que su rostro esté bien iluminado y visible en la cámara (sin gorras, tapabocas, gafas). Si no se detecta un rostro, puede intentar nuevamente o continuar sin registro biométrico. ")],-1)),t("div",Re,[e[14]||(e[14]=t("label",{for:"camera"},"Seleccionar cámara:",-1)),z(t("select",{id:"camera","onUpdate:modelValue":e[5]||(e[5]=a=>C.value=a),class:"rounded-lg w-auto ms-4"},[(D(!0),k(W,null,ce(I.value,a=>(D(),k("option",{key:a.deviceId,value:a.deviceId},J(a.label||"Cámara desconocida"),9,ze))),128))],512),[[de,C.value]]),t("video",{ref_key:"video",ref:d,autoplay:"",muted:"",width:"400",height:"340",class:"rounded-xl shadow-lg flex mx-auto mt-6"},null,512),t("button",{type:"button",disabled:y.value,class:"bg-secondary hover:bg-primary text-sm sm:text-base text-white p-2 rounded-md shadow-xl flex mx-auto mt-4 disabled:bg-gray-500",onClick:e[6]||(e[6]=a=>te())}," Validar ",8,Me),E(" "+J(g.value),1)])]),_:1},8,["show"])],64))}};export{at as default};
