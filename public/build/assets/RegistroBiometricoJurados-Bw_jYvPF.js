import{k as Y,T as ee,r as m,w as $,x as te,a as k,b as j,d as g,u as x,Z as ae,e as D,f as t,y as oe,l as se,i as re,j as N,g as ie,F as P,h as le,t as q,v as ne,s as ce}from"./app-DyeO5CQ9.js";import{_ as de}from"./AuthenticatedLayout-Cy0KizGG.js";import{_ as H}from"./TextInput-DFfsQNez.js";import{_ as ue}from"./InputError-Bx34eM6b.js";import{_ as me}from"./PrimaryButton-DoOUpmv9.js";import{_ as W}from"./Modal-BqVdYs_e.js";import{f as ge}from"./cedulaFrontEjemplo-eqgE4YJW.js";import{d as fe,T as ve,n as R}from"./FaceMatcher-DQZ88WER.js";import{r as pe}from"./PhotoIcon-N3LdBAGS.js";import"./index-DauBk4_h.js";import"./index-Cx-cSyvK.js";import"./index-DYJDQo-Y.js";import"./SecondaryButtonReturn-DTLj9kz1.js";import"./XCircleIcon-CK7N9QDz.js";const he={class:"max-w-2xl mx-auto bg-white shadow-md rounded-lg p-8 mt-8"},be={class:"gap-6"},xe={class:"sm:grid sm:grid-cols-2 gap-2 h-full sm:px-16 px-4"},we={class:"w-full h-full mt-4"},_e={class:"w-full"},ye=["src"],je={class:"mb-2 h-full flex justify-center items-center mt-4"},Ce={class:"border-2 border-gray-300 rounded-md p-2 h-full"},Be={class:"flex justify-center"},Ee=["src","alt"],ke={key:0,class:"flex justify-center mt-2"},De={class:"w-full"},Ie={class:"flex justify-end mt-6"},Fe={class:"flex justify-center my-12"},Me={class:"my-12 px-4"},Ve=["value"],Se=["disabled"],Ge={__name:"RegistroBiometricoJurados",setup(Re){const d=Y("$swal"),A=[{url:"",text:"Registro biometrico"}],s=ee({cedula_front:null,campoObligatorio:"",embedding:null,photo:null,validaciones:"",checked:!0,declaracion:!0}),V=m(!1),f=m(!1),w=m(null),I=m([]),C=m(""),n=m(null),u=m(""),U=m(!1),v=m(!1),y=m(0),J=(o,e)=>s.cedula_front===null?`/storage/uploads/documentos/${o}`:o,Z=(o,e)=>{const r=e.target.files[0];if(!r)return;((c,F)=>{const M=new FileReader;M.onload=S=>{const p=new Image;p.onload=()=>{const i=document.createElement("canvas"),_=i.getContext("2d"),h=1024,E=1024;let l=p.width,b=p.height;(l>h||b>E)&&(l>b?(b=Math.round(b*h/l),l=h):(l=Math.round(l*E/b),b=E)),i.width=l,i.height=b,_.drawImage(p,0,0,l,b),i.toBlob(L=>{if(L.size>2e6){Swal.fire({icon:"error",title:"Error",text:"Incluso comprimida, la imagen supera los 2MB."});return}const O=new File([L],c.name,{type:"image/jpeg",lastModified:Date.now()});F(O,URL.createObjectURL(O))},"image/jpeg",.8)},p.src=S.target.result},M.readAsDataURL(c)})(r,(c,F)=>{s[o]=c,w.value=F})},G=o=>{s.cedula_front=null,w.value=null},K=async()=>{loadingModal.value=!0;try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(a=>a.stop()),await R.tinyFaceDetector.loadFromUri("/models/tiny_face_detector"),await R.faceRecognitionNet.loadFromUri("/models/face_recognition"),await R.faceLandmark68Net.loadFromUri("/models/face_landmark_68");const e=await navigator.mediaDevices.enumerateDevices();I.value=e.filter(a=>a.kind==="videoinput");const r=I.value.find(a=>a.label.toLowerCase().includes("user"))||I.value[0];console.log(r),C.value=(r==null?void 0:r.deviceId)||"",loadingModal.value=!1,f.value=!0,await z(C.value)}catch(o){loadingModal.value=!1,y.value==3,console.error("Error al iniciar:",o),u.value="No se pudo acceder a la cámara."}},Q=async()=>{u.value="",v.value=!0;const o=r=>parseInt(sessionStorage.getItem(r)||"0"),e=(r,a)=>sessionStorage.setItem(r,a.toString());if(!U.value){o("fallo_camara")+1,u.value="La cámara no está lista.",v.value=!1;return}try{const r=await fe(n.value,new ve).withFaceLandmarks().withFaceDescriptor();if(console.log("entro -- validador"),!r){v.value=!1,u.value="No se detectó un rostro.",y.value+=1;const i=document.createElement("canvas");i.width=n.value.videoWidth,i.height=n.value.videoHeight,i.getContext("2d").drawImage(n.value,0,0,i.width,i.height);const h=await new Promise(l=>i.toBlob(l,"image/jpeg")),E=new File([h],"photo.jpg",{type:"image/jpeg"});s.photo=E,y.value==3&&d.fire({title:"Error en validación",text:"Error, no se detectó un rostro, vuelve a intentar o avanzar con la imagen poco visible y posiblemente sin registro biométrico (alta probabilidad de rechazo)",icon:"error",showCancelButton:!1,confirmButtonText:"Volver a intentar"}).then(l=>{l&&(console.log("Usuario decide volver a intentar"),u.value="",y.value=0)});return}const a=r.descriptor;s.embedding=a,console.log("emb",a);const c=document.createElement("canvas");c.width=n.value.videoWidth,c.height=n.value.videoHeight,c.getContext("2d").drawImage(n.value,0,0,c.width,c.height);const M=await new Promise(i=>c.toBlob(i,"image/jpeg")),S=new File([M],"photo.jpg",{type:"image/jpeg"});s.photo=S;const p=new FormData;p.append("embedding",a),v.value=!1,f.value=!1,loadingModal.value=!0,ce.post(route("face-validate-jurado"),p,{headers:{"Content-Type":"multipart/form-data"}}).then(i=>{u.value=i.data.message,console.log(i),v.value=!1,loadingModal.value=!1,i.data.match?d.fire({title:"Error en validación",text:"Usted ya tiene un registro biométrico. Si está seguro que no se ha registrado, puede volver a intentarlo o continuar (probabilidad de rechazo).",icon:"error",showCancelButton:!1,confirmButtonText:"Volver a intentar"}).then(_=>{_.isConfirmed?(s.validaciones="registro_duplicado",f.value=!1,B()):_.dismiss===d.DismissReason.cancel&&console.log("Usuario decide volver a intentar")}):d({title:"Validación exitosa",text:"Validación biométrica exitosa",icon:"success",didClose:()=>{f.value=!1,loadingModal.value=!0,B()}})}).catch(i=>{v.value=!1,loadingModal.value=!1,console.log(i);const _=o("fallo_registro")+1;e("fallo_registro",_),d.fire({title:"Error en validación",text:"Error en la validación, vuelve a intentar o avanzar sin registro biometrico (posibilidad de rechazo)",icon:"error",showCancelButton:!0,cancelButtonText:"Volver a intentar",confirmButtonText:"Continuar"}).then(h=>{h.isConfirmed?(s.embedding="",s.validaciones="fallo_registro_biometrico",f.value=!1,B()):h.dismiss===d.DismissReason.cancel&&console.log("Usuario decide volver a intentar")})})}catch(r){console.error(r),v.value=!1,loadingModal.value=!1,y.value==3&&d.fire({title:"Error en validación",text:"Error al procesar el rostro, vuelve a intentar o avanzar sin registro biometrico (posibilidad de rechazo)",icon:"error",showCancelButton:!0,cancelButtonText:"Volver a intentar",confirmButtonText:"Continuar"}).then(a=>{a.isConfirmed?(s.embedding="",s.validaciones="fallo_registro",f.value=!1,B()):a.dismiss===d.DismissReason.cancel&&(console.log("Usuario decide volver a intentar"),u.value="",y.value=0)}),u.value="Error al procesar el rostro."}},X=()=>{V.value=!1,console.log("Validando datos del paso 3",w.value),(s.cedula_front||w)&&(console.log("Datos del paso 3 son válidos"),V.value=!0),V.value?K():s.cedula_front||(s.errors.cedula_front="Este campo es requerido.")},B=()=>{s.post(route("registro-biometrico-jurado"),{onSuccess:()=>{d({title:"Registro actualizado",text:"Registro de jurado actualizado exitosamente.",icon:"success"}).then(o=>{window.location.href=route("dashboard")}),sessionStorage.removeItem("fallo_camara"),sessionStorage.removeItem("fallo_registro"),sessionStorage.removeItem("registro_duplicado"),s.reset(),T()},onError:o=>{d({title:"Error",text:"Ocurrió un error al registrar el usuario.",icon:"error"}).then(e=>{}),console.error(o)}})},z=async o=>{try{const e=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:o}}});n.value.srcObject=e,U.value=!0}catch(e){console.error("Error al iniciar cámara:",e),u.value="Error al iniciar la cámara."}};$(C,async o=>{o&&await z(o)});const T=()=>{var e;const o=(e=n.value)==null?void 0:e.srcObject;o&&o.getTracks().forEach(r=>r.stop()),n.value.srcObject=null};return $(f,o=>{o==!1&&T()}),(o,e)=>{const r=te("ProgressSpinner");return j(),k(P,null,[g(x(ae),{title:"Registro biométrico de jurados"}),g(de,{breadCrumbLinks:A},{header:D(()=>e[5]||(e[5]=[t("h1",{class:"text-xl font-bold"},"Registro biométrico de jurados",-1)])),default:D(()=>[t("div",he,[t("form",{onSubmit:oe(B,["prevent"])},[t("div",be,[t("div",xe,[e[7]||(e[7]=t("div",{class:"col-span-2 text-sm sm:text-base text-gray-800 pt-6"},[t("h3",{class:"text-lg font-semibold"}," Cargue documento de identificación parte frontal "),t("p",null," Para cargar el documento frontal, asegúrese de que la imagen sea clara y legible. El documento debe estar bien iluminado y sin reflejos. ")],-1)),t("div",we,[t("div",_e,[e[6]||(e[6]=t("h4",{class:"text-2xl underline"},"Ejemplo parte frontal",-1)),t("img",{src:x(ge),alt:"Documento Frontal ejemplo",class:"w-full h-full object-contain mt-2"},null,8,ye)])]),t("div",je,[t("div",Ce,[g(H,{id:"cedula_front",type:"file",class:"mt-1 !border-0",accept:"image/jpeg,image/jpg,image/png,image/gif,image/svg+xml,image/webp",onInput:e[0]||(e[0]=a=>Z("cedula_front",a)),maxFileSize:2e6}),g(ue,{class:"mt-2",message:x(s).errors.cedula_front},null,8,["message"]),t("div",Be,[w.value?(j(),k("img",{key:0,src:J(w.value,1),alt:x(s).cedula_front,class:"w-4/6 h-full object-contain"},null,8,Ee)):(j(),re(x(pe),{key:1,class:"w-2/6 text-gray-300 flex justify-center items-center"}))]),w.value?(j(),k("div",ke,[t("button",{onClick:e[1]||(e[1]=a=>G(1)),type:"button",class:"bg-red-500 text-white px-4 py-2 rounded"}," Eliminar Imagen ")])):se("",!0)])])]),t("div",De,[g(H,{id:"campo_obligatorio",type:"text",class:"mt-3 !border-0 hidden",modelValue:x(s).campoObligatorio,"onUpdate:modelValue":e[2]||(e[2]=a=>x(s).campoObligatorio=a)},null,8,["modelValue"])])]),t("div",Ie,[g(me,{disabled:x(s).processing,onClick:X},{default:D(()=>e[8]||(e[8]=[N(" Registrar jurado ")])),_:1},8,["disabled"])])],32)])]),_:1}),g(W,{show:o.loadingModal,closeable:!1},{default:D(()=>[e[9]||(e[9]=t("h2",{class:"py-4 text-2xl font-semibold text-gray-800 flex tex-center justify-center bg-azul text-white"}," Cargando datos... ",-1)),t("div",Fe,[g(r,{"aria-label":"Loading"})])]),_:1},8,["show"]),g(W,{show:f.value,closeable:!0},{default:D(()=>[e[11]||(e[11]=t("h2",{class:"py-4 text-2xl font-semibold text-gray-800 flex flex-wrap tex-center justify-center bg-azul text-white"}," Validación Biométrica ",-1)),e[12]||(e[12]=t("div",{class:"mt-4 px-4"},[t("p",{class:"text-sm sm:text-base text-gray-800"}," Por favor, asegúrese de que su rostro esté bien iluminado y visible en la cámara (sin gorras, tapabocas, gafas). Si no se detecta un rostro, puede intentar nuevamente o continuar sin registro biométrico. ")],-1)),t("div",Me,[e[10]||(e[10]=t("label",{for:"camera"},"Seleccionar cámara:",-1)),ie(t("select",{id:"camera","onUpdate:modelValue":e[3]||(e[3]=a=>C.value=a),class:"rounded-lg w-auto ms-4"},[(j(!0),k(P,null,le(I.value,a=>(j(),k("option",{key:a.deviceId,value:a.deviceId},q(a.label||"Cámara desconocida"),9,Ve))),128))],512),[[ne,C.value]]),t("video",{ref_key:"video",ref:n,autoplay:"",muted:"",width:"400",height:"340",class:"rounded-xl shadow-lg flex mx-auto mt-6"},null,512),t("button",{type:"button",disabled:v.value,class:"bg-secondary hover:bg-primary text-sm sm:text-base text-white p-2 rounded-md shadow-xl flex mx-auto mt-4 disabled:bg-gray-500",onClick:e[4]||(e[4]=a=>Q())}," Validar ",8,Se),N(" "+q(u.value),1)])]),_:1},8,["show"])],64)}}};export{Ge as default};
