import{k as te,T as oe,r as f,w as q,x as se,a as k,b as j,d as u,u as l,Z as ie,e as B,f as a,y as re,l as le,i as ne,g as U,A,j as E,F as H,h as ce,t as W,v as de,s as ue}from"./app-JinI6ros.js";import{_ as me}from"./AuthenticatedLayout-Din9EHdC.js";import{_ as J}from"./TextInput-BU5G1cEB.js";import{_ as R}from"./InputError-De_-fyoI.js";import{_ as ge}from"./PrimaryButton-6QDZ5COB.js";import{_ as Z}from"./Modal-Dqlec52_.js";import{f as fe}from"./cedulaFrontEjemplo-eqgE4YJW.js";import{d as ve,T as pe,n as z}from"./FaceMatcher-DQZ88WER.js";import{r as be}from"./PhotoIcon-Da57TirP.js";import"./index-7pzIs9HG.js";import"./index-hxFwQSnV.js";import"./index-BJHTBOfZ.js";import"./SecondaryButtonReturn-DAw-iMbg.js";import"./XCircleIcon-Bl3r13W2.js";const he={class:"max-w-2xl mx-auto bg-white shadow-md rounded-lg p-8 mt-8"},xe={class:"gap-6"},we={class:"sm:grid sm:grid-cols-2 gap-2 h-full sm:px-16 px-4"},ye={class:"w-full h-full mt-4"},_e={class:"w-full"},je=["src"],De={class:"mb-2 h-full flex justify-center items-center mt-4"},Ce={class:"border-2 border-gray-300 rounded-md p-2 h-full"},Fe={class:"flex justify-center"},ke=["src","alt"],Be={key:0,class:"flex justify-center mt-2"},Ee={class:"w-full"},Ie={class:"my-4 col-span-2 mb-2"},Me={class:"mb-4 col-span-2 mb-2"},Se={class:"flex justify-end mt-6"},Ve={class:"flex justify-center my-12"},Te={class:"my-12 px-4"},Ue=["value"],Re=["disabled"],Xe={__name:"RegistroBiometricoJurados",setup(ze){const m=te("$swal"),G=[{url:"",text:"Registro biometrico"}],o=oe({cedula_front:null,campoObligatorio:"",embedding:null,photo:null,validaciones:"",checked:!0,declaracion:!0}),V=f(!1),v=f(!1),w=f(null),I=f([]),D=f(""),c=f(null),g=f(""),L=f(!1),p=f(!1),_=f(0),K=(s,e)=>o.cedula_front===null?`/storage/uploads/documentos/${s}`:s,Q=(s,e)=>{const i=e.target.files[0];if(!i)return;((d,M)=>{const S=new FileReader;S.onload=T=>{const b=new Image;b.onload=()=>{const r=document.createElement("canvas"),y=r.getContext("2d"),h=1024,F=1024;let n=b.width,x=b.height;(n>h||x>F)&&(n>x?(x=Math.round(x*h/n),n=h):(n=Math.round(n*F/x),x=F)),r.width=n,r.height=x,y.drawImage(b,0,0,n,x),r.toBlob($=>{if($.size>2e6){Swal.fire({icon:"error",title:"Error",text:"Incluso comprimida, la imagen supera los 2MB."});return}const N=new File([$],d.name,{type:"image/jpeg",lastModified:Date.now()});M(N,URL.createObjectURL(N))},"image/jpeg",.8)},b.src=T.target.result},S.readAsDataURL(d)})(i,(d,M)=>{o[s]=d,w.value=M})},X=s=>{o.cedula_front=null,w.value=null},Y=async()=>{loadingModal.value=!0;try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(t=>t.stop()),await z.tinyFaceDetector.loadFromUri("/models/tiny_face_detector"),await z.faceRecognitionNet.loadFromUri("/models/face_recognition"),await z.faceLandmark68Net.loadFromUri("/models/face_landmark_68");const e=await navigator.mediaDevices.enumerateDevices();I.value=e.filter(t=>t.kind==="videoinput");const i=I.value.find(t=>t.label.toLowerCase().includes("user"))||I.value[0];console.log(i),D.value=(i==null?void 0:i.deviceId)||"",loadingModal.value=!1,v.value=!0,await O(D.value)}catch(s){loadingModal.value=!1,_.value==3,console.error("Error al iniciar:",s),g.value="No se pudo acceder a la cámara."}},ee=async()=>{g.value="",p.value=!0;const s=i=>parseInt(sessionStorage.getItem(i)||"0"),e=(i,t)=>sessionStorage.setItem(i,t.toString());if(!L.value){s("fallo_camara")+1,g.value="La cámara no está lista.",p.value=!1;return}try{const i=await ve(c.value,new pe).withFaceLandmarks().withFaceDescriptor();if(console.log("entro -- validador"),!i){p.value=!1,g.value="No se detectó un rostro.",_.value+=1;const r=document.createElement("canvas");r.width=c.value.videoWidth,r.height=c.value.videoHeight,r.getContext("2d").drawImage(c.value,0,0,r.width,r.height);const h=await new Promise(n=>r.toBlob(n,"image/jpeg")),F=new File([h],"photo.jpg",{type:"image/jpeg"});o.photo=F,_.value==3&&m.fire({title:"Error en validación",text:"Error, no se detectó un rostro, vuelve a intentar o avanzar con la imagen poco visible y posiblemente sin registro biométrico (alta probabilidad de rechazo)",icon:"error",showCancelButton:!1,confirmButtonText:"Volver a intentar"}).then(n=>{n&&(console.log("Usuario decide volver a intentar"),g.value="",_.value=0)});return}const t=i.descriptor;o.embedding=t,console.log("emb",t);const d=document.createElement("canvas");d.width=c.value.videoWidth,d.height=c.value.videoHeight,d.getContext("2d").drawImage(c.value,0,0,d.width,d.height);const S=await new Promise(r=>d.toBlob(r,"image/jpeg")),T=new File([S],"photo.jpg",{type:"image/jpeg"});o.photo=T;const b=new FormData;b.append("embedding",t),p.value=!1,v.value=!1,loadingModal.value=!0,ue.post(route("face-validate-jurado"),b,{headers:{"Content-Type":"multipart/form-data"}}).then(r=>{g.value=r.data.message,console.log(r),p.value=!1,loadingModal.value=!1,r.data.match?m.fire({title:"Error en validación",text:"Usted ya tiene un registro biométrico. Si está seguro que no se ha registrado, puede volver a intentarlo o continuar (probabilidad de rechazo).",icon:"error",showCancelButton:!1,confirmButtonText:"Volver a intentar"}).then(y=>{y.isConfirmed?(o.validaciones="registro_duplicado",v.value=!1,C()):y.dismiss===m.DismissReason.cancel&&console.log("Usuario decide volver a intentar")}):m({title:"Validación exitosa",text:"Validación biométrica exitosa",icon:"success",didClose:()=>{v.value=!1,loadingModal.value=!0,C()}})}).catch(r=>{p.value=!1,loadingModal.value=!1,console.log(r);const y=s("fallo_registro")+1;e("fallo_registro",y),m.fire({title:"Error en validación",text:"Error en la validación, vuelve a intentar o avanzar sin registro biometrico (posibilidad de rechazo)",icon:"error",showCancelButton:!0,cancelButtonText:"Volver a intentar",confirmButtonText:"Continuar"}).then(h=>{h.isConfirmed?(o.embedding="",o.validaciones="fallo_registro_biometrico",v.value=!1,C()):h.dismiss===m.DismissReason.cancel&&console.log("Usuario decide volver a intentar")})})}catch(i){console.error(i),p.value=!1,loadingModal.value=!1,_.value==3&&m.fire({title:"Error en validación",text:"Error al procesar el rostro, vuelve a intentar o avanzar sin registro biometrico (posibilidad de rechazo)",icon:"error",showCancelButton:!0,cancelButtonText:"Volver a intentar",confirmButtonText:"Continuar"}).then(t=>{t.isConfirmed?(o.embedding="",o.validaciones="fallo_registro",v.value=!1,C()):t.dismiss===m.DismissReason.cancel&&(console.log("Usuario decide volver a intentar"),g.value="",_.value=0)}),g.value="Error al procesar el rostro."}},ae=()=>{V.value=!1,console.log("Validando datos del paso 3",w.value),(o.cedula_front||w)&&(console.log("Datos del paso 3 son válidos"),V.value=!0),V.value?Y():o.cedula_front||(o.errors.cedula_front="Este campo es requerido.")},C=()=>{o.post(route("registro-biometrico-jurado"),{onSuccess:()=>{m({title:"Registro actualizado",text:"Registro de jurado actualizado exitosamente.",icon:"success"}).then(s=>{window.location.href=route("dashboard")}),sessionStorage.removeItem("fallo_camara"),sessionStorage.removeItem("fallo_registro"),sessionStorage.removeItem("registro_duplicado"),o.reset(),P()},onError:s=>{m({title:"Error",text:"Ocurrió un error al registrar el usuario.",icon:"error"}).then(e=>{}),console.error(s)}})},O=async s=>{try{const e=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:s}}});c.value.srcObject=e,L.value=!0}catch(e){console.error("Error al iniciar cámara:",e),g.value="Error al iniciar la cámara."}};q(D,async s=>{s&&await O(s)});const P=()=>{var e;const s=(e=c.value)==null?void 0:e.srcObject;s&&s.getTracks().forEach(i=>i.stop()),c.value.srcObject=null};return q(v,s=>{s==!1&&P()}),(s,e)=>{const i=se("ProgressSpinner");return j(),k(H,null,[u(l(ie),{title:"Registro biométrico de jurados"}),u(me,{breadCrumbLinks:G},{header:B(()=>e[7]||(e[7]=[a("h1",{class:"text-xl font-bold"},"Registro biométrico de jurados",-1)])),default:B(()=>[a("div",he,[a("form",{onSubmit:re(C,["prevent"])},[a("div",xe,[a("div",we,[e[9]||(e[9]=a("div",{class:"col-span-2 text-sm sm:text-base text-gray-800 pt-6"},[a("h3",{class:"text-lg font-semibold"}," Cargue documento de identificación parte frontal "),a("p",null," Para cargar el documento frontal, asegúrese de que la imagen sea clara y legible. El documento debe estar bien iluminado y sin reflejos. ")],-1)),a("div",ye,[a("div",_e,[e[8]||(e[8]=a("h4",{class:"text-2xl underline"},"Ejemplo parte frontal",-1)),a("img",{src:l(fe),alt:"Documento Frontal ejemplo",class:"w-full h-full object-contain mt-2"},null,8,je)])]),a("div",De,[a("div",Ce,[u(J,{id:"cedula_front",type:"file",class:"mt-1 !border-0",accept:"image/jpeg,image/jpg,image/png,image/gif,image/svg+xml,image/webp",onInput:e[0]||(e[0]=t=>Q("cedula_front",t)),maxFileSize:2e6}),u(R,{class:"mt-2",message:l(o).errors.cedula_front},null,8,["message"]),a("div",Fe,[w.value?(j(),k("img",{key:0,src:K(w.value,1),alt:l(o).cedula_front,class:"w-4/6 h-full object-contain"},null,8,ke)):(j(),ne(l(be),{key:1,class:"w-2/6 text-gray-300 flex justify-center items-center"}))]),w.value?(j(),k("div",Be,[a("button",{onClick:e[1]||(e[1]=t=>X(1)),type:"button",class:"bg-red-500 text-white px-4 py-2 rounded"}," Eliminar Imagen ")])):le("",!0)])])]),a("div",Ee,[u(J,{id:"campo_obligatorio",type:"text",class:"mt-3 !border-0 hidden",modelValue:l(o).campoObligatorio,"onUpdate:modelValue":e[2]||(e[2]=t=>l(o).campoObligatorio=t)},null,8,["modelValue"])]),a("div",Ie,[U(a("input",{type:"checkbox",id:"consentimiento1",name:"consentimiento1",required:"","onUpdate:modelValue":e[3]||(e[3]=t=>l(o).checked=t)},null,512),[[A,l(o).checked]]),e[10]||(e[10]=a("label",{for:"consentimiento1",class:"ps-4 pe-12 sm:text-base text-sm text-gray-500"},[E("Conozco y Acepto la Política de Privacidad de Datos "),a("a",{href:"https://www.pereira.gov.co/publicaciones/38/politicas-de-privacidad-y-condiciones-de-uso/",target:"_blank",class:"underline !text-azul cursor-pointer"},"Política")],-1)),u(R,{class:"mt-1",message:l(o).errors.checked},null,8,["message"])]),a("div",Me,[U(a("input",{type:"checkbox",id:"consentimiento2",name:"consentimiento2",required:"","onUpdate:modelValue":e[4]||(e[4]=t=>l(o).declaracion=t)},null,512),[[A,l(o).declaracion]]),e[11]||(e[11]=a("label",{for:"consentimiento2",class:"ps-4 pe-12 sm:text-base text-sm text-gray-500"},[E("Manifiesto que acepto, bajo juramento, la "),a("a",{href:"https://www.pereira.gov.co/loader.php?lServicio=Tools2&lTipo=descargas&lFuncion=visorpdf&file=https%3A%2F%2Fwww.pereira.gov.co%2Floader.php%3FlServicio%3DTools2%26lTipo%3Ddescargas%26lFuncion%3DexposeDocument%26idFile%3D211273%26tmp%3De1c59e50ed23a13cda9087f627ac4f4d%26urlDeleteFunction%3Dhttps%253A%252F%252Fwww.pereira.gov.co%252Floader.php%253FlServicio%253DTools2%2526lTipo%253Ddescargas%2526lFuncion%253DdeleteTemporalFile%2526tmp%253De1c59e50ed23a13cda9087f627ac4f4d&pdf=1&tmp=e1c59e50ed23a13cda9087f627ac4f4d&fileItem=211273",target:"_blank",class:"underline !text-azul cursor-pointer"},"Declaración"),E(" sobre la veracidad de la información registrada")],-1)),u(R,{class:"mt-1",message:l(o).errors.declaracion},null,8,["message"])])]),a("div",Se,[u(ge,{disabled:l(o).processing,onClick:ae},{default:B(()=>e[12]||(e[12]=[E(" Registrar jurado ")])),_:1},8,["disabled"])])],32)])]),_:1}),u(Z,{show:s.loadingModal,closeable:!1},{default:B(()=>[e[13]||(e[13]=a("h2",{class:"py-4 text-2xl font-semibold text-gray-800 flex tex-center justify-center bg-azul text-white"}," Cargando datos... ",-1)),a("div",Ve,[u(i,{"aria-label":"Loading"})])]),_:1},8,["show"]),u(Z,{show:v.value,closeable:!0},{default:B(()=>[e[15]||(e[15]=a("h2",{class:"py-4 text-2xl font-semibold text-gray-800 flex flex-wrap tex-center justify-center bg-azul text-white"}," Validación Biométrica ",-1)),e[16]||(e[16]=a("div",{class:"mt-4 px-4"},[a("p",{class:"text-sm sm:text-base text-gray-800"}," Por favor, asegúrese de que su rostro esté bien iluminado y visible en la cámara (sin gorras, tapabocas, gafas). Si no se detecta un rostro, puede intentar nuevamente o continuar sin registro biométrico. ")],-1)),a("div",Te,[e[14]||(e[14]=a("label",{for:"camera"},"Seleccionar cámara:",-1)),U(a("select",{id:"camera","onUpdate:modelValue":e[5]||(e[5]=t=>D.value=t),class:"rounded-lg w-auto ms-4"},[(j(!0),k(H,null,ce(I.value,t=>(j(),k("option",{key:t.deviceId,value:t.deviceId},W(t.label||"Cámara desconocida"),9,Ue))),128))],512),[[de,D.value]]),a("video",{ref_key:"video",ref:c,autoplay:"",muted:"",width:"400",height:"340",class:"rounded-xl shadow-lg flex mx-auto mt-6"},null,512),a("button",{type:"button",disabled:p.value,class:"bg-secondary hover:bg-primary text-sm sm:text-base text-white p-2 rounded-md shadow-xl flex mx-auto mt-4 disabled:bg-gray-500",onClick:e[6]||(e[6]=t=>ee())}," Validar ",8,Re),E(" "+W(g.value),1)])]),_:1},8,["show"])],64)}}};export{Xe as default};
